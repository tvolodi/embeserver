<!DOCTYPE HTML>
<html>
<head>

   

</head>

<body>
    <div id="remote_url">
        <a href="javascript:setRemoteConnString()">Set remote URL</a>
    </div>
    <div id="sse">
        <a href="javascript:connectWS()">Connect to WS Server</a>
    </div>
    <div id="read_tag">
        <a href="javascript:readTag()">Read a Tag</a>
    </div>

    <div id="read_tag_continuous">
        <a href="javascript:readTags()">Read Tags Continuously</a>
    </div>


    <div id="get_tag_distance">
        <a href="javascript:getTagDistance()">Get Distance to Tag</a>
    </div>

    <div id="stop_read_tag">
        <a href="javascript:stopReadTags()">Stop Read Tags</a>
    </div>
    
    <div id="locating_tag">
        <a href="javascript:locatingTag()">Locating Tags</a>
    </div>


    <div id="launch_app">
        <div>
            <a href="javascript:launchApp()">Launch Driver App</a>
        </div>
        <div>
            <a href="intent://vt-ptm.org/#Intent;scheme=https;action=android.intent.action.VIEW;end"> Launch 2 </a>
        </div>
    </div>
    


    <!-- <div id="add_tag_list_item">
        <a href="javascript:addItem('tag')">Add item a Tag</a>
    </div> -->

    <div id="build_table">
        <a href="javascript:buildTable()">Build Tag Table</a>
    </div>

    <table id="taglist">
        <tr>
            <th>RFID</th>
            <th>Qnt</th>
        </tr>
    </table>

    <p id="msg_info"></p>

    <div id="epc_data"></div>
    <script type="text/javascript">

        let connString = "ws://localhost:38301/"

        let ws = {}

        let isOpened = false;

        let msgCounter = 0;

        let tagList = [] // tag: qnt
        tagList.push(
            {
                tagCode: "Test",
                readQnt: 0,
                rssi: 0,
                relativeDistance: 0,
            }
        )

        const WSCommands = {
            TEST: "test",
            GET_TAG_DISTANCE: "get_tag_distance",
            LOCATE_TAG: "locate_tag",
            READ_TAG: "read_tag",
            READ_TAG_CONTINUOUS: "read_tag_continuous",
            SET_POWER: "set_power",
            STOP_READING: "stop_reading",
            SET_OPERATION_TYPE: "operation_type",
        }

        const Responses = {
            GOT_TAG_DISTANCE: "got_tag_distance",
            GOT_EPC: "got_epc",
            ERROR: "error",
        }

        const Dividers = {
            FIELD_DIVIDER: "::",
            VALUE_DIVIDER: "|",
            SUBVALUE_DIVIDER: ";",
        }

        let lastReadTag = ""


        //		document.addEventListener('keydown', (event) => {
        //			const name = event.key;
        //			const code = event.code;
        //			alert(`key downed: ${name} :: key code: ${code}`);
        //		}, true)

        //		document.addEventListener('keypress', (event) => {
        //			console.log(event);
        //			const name = event.key;
        //			const code = event.code;
        //			alert(`key pressed: ${name} :: key code: ${code}`);
        //		}, true)

        //		document.addEventListener('keyup', (event) => {
        //			const name = event.key;
        //			const code = event.code;
        //			alert(`key uped: ${name} :: key code: ${code}`);
        //		}, true)


        function addItem (tagNumber) {
            var list = document.getElementById('tag_list');
            var entry = document.createElement('li');
            entry.appendChild(document.createTextNode(tagNumber));
            list.appendChild(entry);
        }

        function setRemoteConnString () {
            connString = "ws://192.168.1.71:38301/"
        }

        function clearMessageInfo () {
            const msgInfoElement = document.getElementById("msg_info")
            msgInfoElement.innerHTML = ""
        }

        function connectWS () {


            
            // Open a web socket
            try {
                clearMessageInfo();
                ws = new WebSocket(connString);
            } catch (e) {
                alert(e)
            }

            ws.onopen = function () {

                // Web Socket is connected, send data using send()
                ws.send("Message to send");
                isOpened = true;
                // alert("Message is sent...");
            };

            ws.onmessage = async function (evt) {

                // alert("On message");
                
                msgCounter++;

                const receivedMsg = evt.data;

                // alert(`receivedMsg ${receivedMsg}`)

                const msgInfoElement = document.getElementById("msg_info")
                msgInfoElement.innerHTML = receivedMsg

                let epcDataElement = document.getElementById("epc_data");

                const messageArr = receivedMsg.split(Dividers.FIELD_DIVIDER);
                const operationName = messageArr[0];

                switch (operationName) {

                    case Responses.GOT_EPC:
                        if (messageArr.length >= 2) {
                            const tagDataString = messageArr[1]
                            const tagDataArr = tagDataString.split(Dividers.VALUE_DIVIDER)
                            for (let j = 0; j < tagDataArr.length; j++) {
                                let tagData = tagDataArr[j]
                                let tagDataElements = tagData.split(Dividers.SUBVALUE_DIVIDER)
                                let epc = tagDataElements[0]
                                let tagRssi = tagDataElements[1]
                                let tagRelativeDistance = tagDataElements[2]
                                let listItem = tagList.find(item => item.tagCode == epc)
                                try {
                                    if (listItem != null) {
                                        listItem.readQnt++;
                                        listItem.rssi = tagRssi;
                                        listItem.relativeDistance = tagRelativeDistance;
                                    } else {

                                        listItem = {
                                            tagCode: epc,
                                            readQnt: 1,
                                            rssi: tagRssi,
                                            relativeDistance: tagRelativeDistance
                                        };
                                        tagList.push(listItem);
                                    }
                                } catch (e) {
                                    alert(`Exception for list item for msg ${msgCounter}: ${e}`)
                                }
                            }
                            await buildTable()
                        }
                        break;

                    case Responses.
                        default:
                }
                // alert("Message is received: " + received_msg);
            };

            ws.onclose = function () {

                // websocket is closed.
                isOpened = false
                alert("Connection is closed...");
            };
        }

        function launchApp () {
            const url = "intent://www.vt-ptm.org/#Intent;" +
                "schema=https;" +
                //"package=kz.ascoa.embeserver.DriverService;"+
                "action=android.intent.action.VIEW;" +
                // "category=;"+
                "end"
            window.location.replace(url)
        }

        function getTagDistance () {
            ws.send("get_tag_distance")
        }

        function locatingTag () {
            ws.send(WSCommands.LOCATE_TAG);
        }

        function readTag () {
            clearMessageInfo();
            ws.send("read_tag")
        }

        function readTags () {
            ws.send("read_tag_continuous")
        }

        function stopReadTags () {
            ws.send(WSCommands.STOP_READING)
        }

        async function buildTable () {

            let tbl = document.getElementById("tag_table")

            if (tbl != null) tbl.remove()

            tbl = document.createElement("table")
            tbl.setAttribute('id', 'tag_table')

            const tblBody = document.createElement("tbody")
            for (let i = 0; i < tagList.length; i++) {

                const tagInfo = tagList[i]

                const row = document.createElement("tr")
                const col1Cell = document.createElement("td")
                const col1CellValue = document.createTextNode(tagInfo.tagCode)
                col1Cell.appendChild(col1CellValue)
                row.appendChild(col1Cell)
                const col2Cell = document.createElement("td")
                const col2CellValue = document.createTextNode(tagInfo.readQnt)
                col2Cell.appendChild(col2CellValue)
                row.appendChild(col2Cell)
                const col3Cell = document.createElement("td")
                const col3CellValue = document.createTextNode(tagInfo.rssi)
                col3Cell.appendChild(col3CellValue)
                row.appendChild(col3Cell)
                const col4Cell = document.createElement("td")
                const col4CellValue = document.createTextNode(tagInfo.relativeDistance)
                col4Cell.appendChild(col4CellValue)
                row.appendChild(col4Cell)
                tblBody.appendChild(row)
            }
            tbl.appendChild(tblBody)
            document.body.appendChild(tbl)
        }


    </script>
</body>

</html>